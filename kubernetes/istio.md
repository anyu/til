# Istio

## What is it & why is it useful

Istio is an implementation of a *service mesh*. A service mesh is a pattern for managing communication between services.

Why do we need a service mesh?

- Communication inside a cluster is not secure by default; any service can talk to another service.
- Communication between services (pods) may need configuration
- Monitoring & metrics need to be configured

Without a service mesh, the above logic needs to be added for each service.

## Service mesh with sidecar pattern

With a sidecar proxy, it can handle
- networking logic
- metrics, tracing, retry logic

Business logic can be left to actual service.

A service mesh makes use of a control plane that injects this sidecar proxy inside every service pod (separate container)

## Istio Architecture

- Istio relies on Envoy for L7 traffic management.
- Istio itself is a control plane for a fleet of Envoy Proxies

### Proxies

Istio uses envoy for its proxies.

### Control Plane

Istio's control plan for managing its proxies is Istiod.
Istiod manages and injects the envoy proxies in each service pod.

## Other benefits
- Traffic splitting

## Configuring Istio

- Istio configuration is managed separately from application configuration - don't have to adjust k8s deployment/service files.
- Istio uses k8s CRDs, so can be configured via k8s yaml files
  - CRDs extend the k8s API, enables custom k8s resources

Three ways to install Istio:
- Helm (no longer recommended)
- Istioctl
- Istio operator - manages lifecycle, but has some light security concerns

## Istio CRDs

Istio has two CRDs: VirtualService and DestinationRule. Istiod converts these routing rules to Envoy configurations.

### VirtualService

A resource to configure how you route your traffic to a destination.

### DestinationRule

A resource to configure what happens to traffic for that destination.

### Gateway

We don't configure proxies directly; we configure Istiod.
Proxies can communicate without connecting to Istiod.

## Other Istio Features

- **Service discovery**: Istiod has a central registry for each service, gets automatically registered
- **Certificate management**: Istiod also acts as a CA, generates certs for all services in cluster to enable TLS communication between services
- **Telemetry**: Istiod gathers metrics from proxies and can be consumed by Promethesus

## Istio Ingress Gateway

- Entrypoint to your cluster
- alternative to NGINX controller
- runs as a pod in cluster, acts as a load balancer to your cluster. Directs traffic to a service via VirtuslService.

## Istio Traffic flow

1. Request comes in
2. Hits Istio Ingress Gateway - gateaway evaluates the VirtualService rules
3. VirtualService sends it to a service (connection is secured via mTLS)
4. Request reaches the proxy sidecar, proxy evaluates request and forwards it to the service via localhost
5. If Service A needs to reach Service B, Service A's proxy's VirtualService and DestinationRule sends traffic to Service B's proxy (connection is secured via mTLS)

https://istio.io/latest/docs/ops/configuration/traffic-management/tls-configuration/

## mTLS in Istio

Istio mTLS is enabled by default when installed. There are three mTLS modes with Istio:
- **Disable**: mTLS is disabled
- **Permissive** (default): Accepts both plaintext and mTLS traffic
- **Strict**: only accepts mTLS traffic

## Using certs

By default, Istio generates a self-signed root certificate and key to sign certs.

Most likely you want your own CA and sign certs with it.

1. Create a cert
2. Create a k8s secret to hold the cert

mTLS can be enabled on three levels:
- **Service**: mTLS can be enabled on a set of services
- **Namespace**: mTLS can be enabled for a whole namespace
- **Mesh**: mTLS can be enabled for the entire mesh network

Istiod mounts client certs into the proxies.

## TLS connection modes

- `SIMPLE`:	Originate a TLS connection to the upstream endpoint
- `MUTUAL`:	Secure connections to the upstream using mTLS by presenting client certs.
- `ISTIO_MUTUAL`: Secure connections to the upstream using mTLS by presenting client certs. Difference with `MUTUAL`: this mode uses certs autogenerated by Istio.

Deploying Istio
https://sfeir.github.io/kubernetes-istio-workshop/kubernetes-istio-workshop/1.0.0/istio/01_setup_istio.html#deploy-istio

https://istiobyexample.dev/mtls/

### Debugging istio

Get mesh status overview - shows if a proxy isn't receiving configuration or is out of sync
```shell
istioctl proxy-status
```

```shell
istioctl proxy-config cluster -n istio-system istio-ingressgateway-XXX
```

Request listener configuration (configuration of the proxy regarding incoming requests)
```shell
istioctl proxy-config listener POD_NAME
```

Access Envoy dashboard
```shell
istioctl dashboard envoy POD_NAME
```

Get info about a k8s service in the context of Istio
```shell
istioctl experimental describe service SERVICE_NAME
```
