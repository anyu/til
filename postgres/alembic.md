# Alembic

[Alembic](https://alembic.sqlalchemy.org) is SQLalchemy's migration management tool.
Alembic detects changes to DB models to autogenerate and apply migration scripts.

## Alembic setup

1. Installation: `pip install alembic`
2. One-time initialization: `alembic init alembic`

The following captures the [directory structure](https://alembic.sqlalchemy.org/en/latest/tutorial.html#the-migration-environment) with alembic:
```
alembic/
    env.py
    README
    script.py.mako
    versions/
        2022_09_01_0950-80d084d56c07_add_XXX.py
alembic.ini
```

| Dir/file name        | Description
| :------------- |:-------------
| `alembic/env.py` | Autogenerated from the initial `alembic init` command. This is where dynamic configs can be added (connection to DB, models, etc)
| `alembic/script.py.mako`    | Template file used to generate the migration scripts. Autogenerated from the initial `alembic init` command.
| `alembic/versions/***`      | Where autogenerated and manual migration scripts live. Autogenerated from `alembic revision --autogenerate` command.
| `alembic.ini`      | The file that the alembic script looks for when invoked. Changes from `env.py` may override configs in this file. Autogenerated from the initial `alembic init alembic` command.


## Generating/applying migration scripts

`alembic revision -m "some description of change"`

This will create a file `$REVISION_ID_some_description_of_change.py`. Edit as needed.

Alembic can also autogenerate migration scripts based on our DB models (need to tweak `env.py` so it's aware of models)

**NOTE**: There are [limitations](https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect) to what it can/can't detect, so manual adjustments may need to be made.

To autogenerate a migration script: `alembic revision --autogenerate -m "some description of change"`

To apply migrations not yet applied: `alembic upgrade head`

### How it works under the hood

Each migration script references the previous script's revision ID/hash (essentially creating a linked list of changes to the DB schema)

On the first migration apply, Alembic creates an `alembic_version` table in the DB. This table just stores the revision ID of the last script applied:

```shell
# alembic_version table contents
 version_num
--------------
 50791dd06f70
```

It checks this table for the current version, then calculates the path from this version to the version requested.

It then invokes the `upgrade()` method of the migration scripts to get to the target revision.

## Rollbacks

Roll back last migration: `alembic downgrade -1`

Roll back specific migration:
```
alembic history # Get list of ran migrations with hash

alembic downgrade <HASH>
```

```sh
pip install alembic

# Init alembic in project root
alembic init alembic
```

Output:
```sh
project
│   alembic.ini
│   config.py
│   crud.py
│   models.py
│
└───alembic
    │   env.py
    │   README
    │   script.py.mako
    │
    └───versions
```

## Core commands

```
# Generate a migration
# May need to manually modify after
alembic revision --autogenerate -m "Added price column"

# Run the upgrade cmd
alembic upgrade head

# See ran migrations
# alembic history

# Rollback last migration
alembic downgrade -1

# Rollback specific migration
alembic downgrade HASH

# Rollback all migrations
alembic downgrade base
```

## More commands

```
# Make alembic think NO migrations have been run (but won't undo migrations)
# maybe useful for specific cases...
alembic stamp base
```
